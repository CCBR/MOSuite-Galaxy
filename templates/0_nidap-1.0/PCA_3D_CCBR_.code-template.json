{
	"codeTemplate": "PCA_3D <- function({{{Counts_Matrix}}}, {{{Sample_Metadata_Table}}}) {\n\n## This function generates an interactive 3D PCA plot\n\n## --------- ##\n## Libraries ##\n## --------- ##\n\nlibrary(edgeR)\nlibrary(colorspace)\nlibrary(plotly)\nlibrary(htmlwidgets)\n    \n## -------------------------------- ##\n## User-Defined Template Parameters ##\n## -------------------------------- ##\n\n# Basic parmaters\nCounts_Matrix <- {{{Counts_Matrix}}}\nSample_Metadata_Table <- {{{Sample_Metadata_Table}}}\nFeatureID_Name_Column <- \"{{{FeatureID_Name_Column}}}\"\nSample_Names_Column <- \"{{{Sample_Names_Column}}}\"\nSamples_to_Include <- {{{Samples_to_Include}}}\nGroup_Column <- \"{{{Group_Column}}}\"\nPlot_Labels_Column <-\"{{{Plot_Labels_Column}}}\"\nSamples_to_Rename_Manually <- {{{Samples_to_Rename_Manually}}}\n# Advanced parameters\nOutlier_Samples_to_Remove <- {{{Outlier_Samples_to_Remove}}}\nUse_CPM <- {{{Use_CPM}}}  \n# Visualization parameters\nPoints_Size <-{{{Point_Size}}}\nPoint_Color <- {{{Point_Color}}}\nPlot_Title <- \"{{{Plot_Title}}}\"    \n\n##--------------- ##\n## Error Messages ##\n## -------------- ##\n\n## --------- ##\n## Functions ##\n## --------- ##\n\n# generate random colors\ngetourrandomcolors <- function(k) {\n  seed = 10\n  n <- 2e3\n  ourColorSpace <- colorspace::RGB(runif(n), runif(n), runif(n))\n  ourColorSpace <- as(ourColorSpace, \"LAB\")\n  currentColorSpace <- ourColorSpace@coords\n  # Set iter.max to 20 to avoid convergence warnings.\n  set.seed(seed)  \n  km <- kmeans(currentColorSpace, k, iter.max = 20)\n  return(unname(hex(LAB(km$centers))))\n}\n\n## --------------- ##\n## Main Code Block ##\n## --------------- ##\n\n###########################################\n#This code block does input data validation\n\n# get the sample data\n\n# remove outliers\nSamples_to_Include <-\n  Samples_to_Include[!Samples_to_Include %in% Outlier_Samples_to_Remove]\n# include samples\nSamples_to_Include <-\n  Samples_to_Include[Samples_to_Include != FeatureID_Name_Column]\n  cat(sprintf(\"Total number of samples included in the PCA plot: %g\", length(Samples_to_Include)))\nCounts_Matrix[, append(FeatureID_Name_Column, Samples_to_Include)] -> df\nSample_Metadata_Table <-\n  Sample_Metadata_Table[Sample_Metadata_Table[, Sample_Names_Column]  %in% Samples_to_Include, ]\nSampinfo <- Sample_Metadata_Table\ncolnames(df)[colnames(df) == FeatureID_Name_Column] <- \"Gene\"\ndf -> edf.orig\n\n###### PCA plot ##############\n\n# evaluate and display PCA plot\nrownames(Sampinfo) <- Sampinfo[, Sample_Names_Column]\nSampinfo <-\n  Sampinfo[match(colnames(edf.orig[, -1]), Sampinfo[, Sample_Names_Column]),]\nSampinfo = Sampinfo[complete.cases(Sampinfo[, Sample_Names_Column]), ]\ncat(paste0(\n  \"\\nTotal number of genes included in the PCA plot: \",\n  nrow(edf.orig)\n))\nedf <- edf.orig[, match(Sampinfo[, Sample_Names_Column], colnames(edf.orig))]\nidx = !rowMeans(edf) == 0\nif (Use_CPM) {\n  edf = edgeR::cpm(edf[idx, ])\n}\nedf.orig = edf.orig[idx, ]\ntedf <- t(edf)\ncolnames(tedf) <- edf.orig[, 1]\ntedf <- tedf[, colSums(is.na(tedf)) != nrow(tedf)]\ntedf <- tedf[, apply(tedf, 2, var) != 0]\npca <- prcomp(tedf, scale. = T)\npca.df <- as.data.frame(pca$x)\npca.df$group <- Sampinfo[, Group_Column]\npca.df$sample <- Sampinfo[, Plot_Labels_Column]\n\n# pca stats\nstats <-\n  data.frame(id = paste0(\"PC\", 1:length(pca$sdev)),\n             eigenvalue = (pca$sdev) ^ 2) %>% mutate(variance = eigenvalue * 100 / sum(eigenvalue)) %>% mutate(cumvariance =\n                                                                                                                 cumsum(variance)) %>% mutate(\n                                                                                                                   variance_label = sprintf(\"%s (%.1f%% variance)\", id, variance),\n                                                                                                                   cumvariance_label = sprintf(\"%s (%.1f%% cumulative variance)\", id, cumvariance)\n                                                                                                                 )\naxis_title = sub(\" variance\", \"\", stats$variance_label)\n# if rename samplea\nif (!is.null(Samples_to_Rename_Manually)) {\n  if (Samples_to_Rename_Manually != c(\"\")) {\n    for (x in Samples_to_Rename_Manually) {\n      old <- strsplit(x, \": ?\")[[1]][1]\n      new <- strsplit(x, \": ?\")[[1]][2]\n      pca.df$sample <-\n        ifelse(pca.df$sample == old, new, pca.df$sample)\n    }\n  }\n}\n# set the colors to be used in the plot\nif (length(unique(Sampinfo[, Group_Column])) > length(Point_Color)) {\n  ## Original color-picking code.\n  k = length(unique(Sampinfo[, Group_Column])) - length(Point_Color)\n  more_cols <- getourrandomcolors(k)\n  Point_Color <- c(Point_Color , more_cols)\n} else {\n  Point_Color <- Point_Color[1:length(unique(Sampinfo[, Group_Column]))]\n}\nnames(Point_Color) <- unique(Sampinfo[, Group_Column])\n# set label size (may add to user-defined parameters in the future)\nLabel_Font_Size <- 24\n\n# plot PCA\ncat(\"\\nRunning PCA...\")\nfig <- plot_ly(\n    pca.df,\n    x = ~ PC1,\n    y = ~ PC2,\n    z = ~ PC3,\n    color = ~ group,\n    colors = Point_Color,\n    type = \"scatter3d\",\n    mode = \"markers\",\n    marker = list(size = Points_Size),\n    hoverinfo = 'text',\n    text = ~ sample,\n    size = Label_Font_Size\n  )\nlegend = TRUE\nif (legend == FALSE) {\n    fig <- hide_legend(fig)\n}\nfig <-\n    fig %>% layout(\n      title = list(text = Plot_Title, size = 5),\n      scene = list(\n        xaxis = list(title = axis_title[1]),\n        yaxis = list(title = axis_title[2]),\n        zaxis = list(title = axis_title[3])\n    ),\n      legend = list(\n        itemsizing = 'constant',\n        size = 12,\n        y = 0.5\n    )\n)\n  \n###### OUTPUT ##############\n# save in dataset container\noutput <- new.output()\noutput_fs <- output$fileSystem()\n# html widget\nhtml_file <- sprintf(\"Plot_%s.html\", gsub(\" \", \"_\", Plot_Title))\nhtmlwidgets::saveWidget(fig, html_file)\noutput_fs$upload(html_file, html_file)\ncat(sprintf(\"\\nFiles saved in the output dataset:\\n• %s\", html_file))\n# components table\ncomponent_file <-\n    sprintf(\"Components_%s.csv\", gsub(\" \", \"_\", Plot_Title))\n    write.csv(stats, row.names = FALSE, output_fs$get_path  (component_file, 'w'))\ncat(sprintf(\"\\n• %s\", component_file))\n# coordinates table\ncoordinate_file <-\n    sprintf(\"Coordinates_%s.csv\", gsub(\" \", \"_\", Plot_Title))\nwrite.csv(pca.df,\n        row.names = FALSE,\n        output_fs$get_path(coordinate_file, 'w'))\ncat(sprintf(\"\\n• %s\", coordinate_file))\n  \n  ## keep for later solution to quality of the downloaded static image\n  #fig = config(fig, toImageButtonOptions = list(format= 'svg', # one of png, svg, jpeg, webp\n  #filename= sub(\".html\",\"\", html_file), height= 300, width= 500,           scale= 1))  \n  \n# display visualization\nprint(fig)\n\n}\n\n## ---------------------------- ##\n## Global Imports and Functions ##\n## ---------------------------- ##\n\n## Functions defined here will be available to call in\n## the code for any table.\n\n## --------------- ##\n## End of Template ##\n## --------------- ##\n",
	"columns": [
		{
			"key": "FeatureID_Name_Column",
			"displayName": "FeatureID Name Column",
			"description": "The column from your counts matrix containing the Feature IDs (such as gene names, isoform names and so on). This is usually the first column of your counts matrix.",
			"paramGroup": "Basic",
			"sourceDataset": "Counts_Matrix",
			"defaultValue": null,
			"columnType": "STRING",
			"isMulti": null
		},
		{
			"key": "Sample_Names_Column",
			"displayName": "Sample Names Column",
			"description": "The column from your sample metadata table containing the sample names. These should be the same as the sample names found in the column names of the counts matrix.",
			"paramGroup": "Basic",
			"sourceDataset": "Sample_Metadata_Table",
			"defaultValue": null,
			"columnType": "STRING",
			"isMulti": null
		},
		{
			"key": "Samples_to_Include",
			"displayName": "Samples to Include",
			"description": "Which samples would you like to include? Usually, you will choose to \"Add all\" samples. Excluded samples will be removed from downstream analysis. Only Numeric columns can be selected.",
			"paramGroup": "Basic",
			"sourceDataset": "Counts_Matrix",
			"defaultValue": null,
			"columnType": "NUMBER",
			"isMulti": true
		},
		{
			"key": "Group_Column",
			"displayName": "Group Column",
			"description": "The column from your sample metadata table containing sample group information. This is usually a column showing which of your experimental treatments each sample belongs to (e.g. WildType, Knockout, Tumor, Normal, Before, After, etc.).",
			"paramGroup": "Basic",
			"sourceDataset": "Sample_Metadata_Table",
			"defaultValue": null,
			"columnType": "ALL",
			"isMulti": null
		},
		{
			"key": "Plot_Labels_Column",
			"displayName": "Plot Labels Column",
			"description": "The column from your sample metadata table containing the sample names as you wish them to appear in the QC figure. This is often the same Sample Name Column (see parameter above). However, you may desire different labels to display on your PCA figure (e.g. shorter labels). These labels can be added as an additional column in your metadata table and used here to label your plot.",
			"paramGroup": "Basic",
			"sourceDataset": "Sample_Metadata_Table",
			"defaultValue": null,
			"columnType": "ALL",
			"isMulti": null
		},
		{
			"key": "Outlier_Samples_to_Remove",
			"displayName": "Outlier Samples to Remove",
			"description": "Enter outlier samples you want to remove from analysis here and downstream of this template.",
			"paramGroup": "Advanced",
			"sourceDataset": "Counts_Matrix",
			"defaultValue": null,
			"columnType": "NUMBER",
			"isMulti": true
		}
	],
	"condaDependencies": [],
	"description": "This template is based on Bulk RNA-seq QC PCA template and is intended to provide interactive 3D view of a PCA plot generated from the data.",
	"externalId": "PCA_3D_CCBR_",
	"inputDatasets": [
		{
			"key": "Counts_Matrix",
			"displayName": "Counts Matrix",
			"description": "The input counts matrix from which you want to build a 3D PCA plot. This will usually be either Filtered Counts, Normalized Counts, or Batch Corrected Counts.",
			"paramGroup": "Basic",
			"anchorDataset": false,
			"dataType": "R_NATIVE_DATAFRAME",
			"tags": []
		},
		{
			"key": "Sample_Metadata_Table",
			"displayName": "Sample Metadata Table",
			"description": "The input sample metadata table.",
			"paramGroup": "Basic",
			"anchorDataset": false,
			"dataType": "R_NATIVE_DATAFRAME",
			"tags": []
		}
	],
	"vectorLanguage": "R",
	"codeLanguage": "R",
	"parameters": [
		{
			"key": "Samples_to_Rename_Manually",
			"displayName": "Samples to Rename Manually",
			"description": "If you do not have a Plot Labels Column (see above) in your sample metadata table, you can use this parameter to rename samples manually for display on the PCA plot. Use \"Add item\" to add each additional sample for renaming. Use the following format to describe which old name (in your sample metadata table) you want to rename to which new name:\n\nold_name: new_name",
			"paramType": "VECTOR",
			"paramGroup": "Basic",
			"paramValues": null,
			"defaultValue": null,
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Use_CPM",
			"displayName": "Use CPM",
			"description": "Set to TRUE if you want to enable CPM normalization for counts matrix",
			"paramType": "BOOLEAN",
			"paramGroup": "Advanced",
			"paramValues": null,
			"defaultValue": "FALSE",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Point_Size",
			"displayName": "Point Size",
			"description": "The size of the points in the 3D PCA plot.",
			"paramType": "NUMBER",
			"paramGroup": "Visualization",
			"paramValues": null,
			"defaultValue": "8",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Point_Color",
			"displayName": "Point Color",
			"description": "Colors for the PCA will be picked, in order, from this list. There are thousands of colors. You may remove or add colors as you choose, but take care that there are always at least as many colors in this list than you need to color items in your plot.\n\nExample: if you are coloring by Group and have 3 groups, you should have at least 3 colors in your list.",
			"paramType": "MULTISELECT",
			"paramGroup": "Visualization",
			"paramValues": [
				"slateblue3",
				"tomato2",
				"maroon",
				"deepskyblue",
				"mediumorchid2",
				"mediumseagreen",
				"salmon",
				"dodgerblue",
				"darkgreen",
				"plum4",
				"orange",
				"yellow4",
				"aquamarine3",
				"salmon1",
				"lightskyblue3",
				"plum3",
				"firebrick",
				"darkolivegreen3",
				"goldenrod1",
				"burlywood2",
				"gray70",
				"firebrick2",
				"steelblue",
				"palegreen4",
				"orchid4",
				"darkorange1",
				"yellow",
				"sienna",
				"palevioletred1",
				"gray60",
				"cyan4",
				"darkorange3",
				"mediumpurple3",
				"violetred2",
				"olivedrab",
				"darkgoldenrod2",
				"darkgoldenrod",
				"gray40",
				"palegreen3",
				"thistle3",
				"khaki1",
				"deeppink2",
				"chocolate3",
				"paleturquoise3",
				"wheat1",
				"lightsteelblue",
				"sandybrown",
				"darkolivegreen2",
				"thistle2",
				"gray85",
				"orchid3",
				"darkseagreen1",
				"lightgoldenrod1",
				"lightskyblue2",
				"dodgerblue3",
				"darkseagreen3",
				"forestgreen",
				"lightpink2",
				"mediumpurple4",
				"lightpink1",
				"thistle",
				"navajowhite",
				"lemonchiffon",
				"bisque2",
				"mistyrose",
				"gray95",
				"lightcyan3",
				"peachpuff2",
				"lightsteelblue2",
				"lightyellow2",
				"moccasin",
				"antiquewhite2",
				"gray80",
				"lightgrey"
			],
			"defaultValue": "c(\"slateblue3\",\"tomato2\",\"maroon\",\"deepskyblue\",\"mediumorchid2\",\"mediumseagreen\",\"salmon\",\"dodgerblue\",\"darkgreen\",\"plum4\",\"orange\",\"yellow4\")",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Plot_Title",
			"displayName": "Plot Title",
			"description": "",
			"paramType": "STRING",
			"paramGroup": "Visualization",
			"paramValues": null,
			"defaultValue": "PCA 3D",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		}
	],
	"title": "PCA 3D [CCBR]",
	"templateApiVersion": "0.1.0"
}