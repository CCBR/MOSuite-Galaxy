{
	"codeTemplate": "VolcanoPlot <- function({{{DEG_Table}}}) {\n    # image: png\n\n\n    # Changelog\n    # 2022-09-14 Rearranged structure and description\n    # 2020-10-29 Add support for pval == 0\n\n\n\n    ## --------- ##\n    ## Libraries ##\n    ## --------- ##\n\n    library(stringr)\n    library(ggplot2)\n    library(ggrepel)\n    library(dplyr)\n    library(tidyr)\n\n    library(EnhancedVolcano)\n    # For interactive plot:\n    library(plotly)\n    library(grid)\n    \n\n    ## -------------------------------- ##\n    ## User-Defined Template Parameters ##\n    ## -------------------------------- ##\n\n    #Basic Parameters:\n    df.orig <- {{{DEG_Table}}}\n    label.col <- \"{{{Column_with_Feature_ID}}}\"\n    sig.col <- {{{Significance_Column}}}\n    pCutoff  = {{{P_Value_Threshold}}}\n    lfc.col <- {{{Log2_Fold_Change_Column}}}\n    FCcutoff = {{{Log2_Fold_Change_Threshold}}}\n   \n    \n    #Label Parameters\n    value_to_sort_the_output_dataset <- \"{{{Choose_Feature_to_Label_By}}}\"\n    no_genes_to_label <- {{{Number_of_Features_to_Label}}}\n    use_only_addition_labels <- {{{Label_Only_My_Feature_List}}}\n    additional_labels <- \"{{{My_Feature_List}}}\"\n    is_red <- {{{Top_Genes_Labeled_Only_If_Passing_Thresholds}}}\n    labSize <- {{{Label_Size}}}    \n\n\n    #Title and Axis labels Parameters\n    change_sig_name <- \"{{{Custom_Significance_Label}}}\"\n    change_lfc_name <- \"{{{Custom_Log_Fold_Change_Label}}}\"\n    title <- \"{{{Plot_Title}}}\"\n    #subtitle <- \"\"\n    use_custom_lab <- {{{Use_Custom_Axis_Label}}}\n            \n    #Plot Parameters\n    ylim <- {{{Y_Limit}}}\n    custom_xlim <- \"{{{Custom_X_axis_limits}}}\"\n    xlim_additional <- {{{X_Limit_Padding}}}\n    ylim_additional <- {{{Y_Limit_Padding}}}\n    axisLabSize <- {{{Axis_Label_Size}}}\n    pointSize <- {{{Point_Size}}}\n\n\n    #Image Parameters\n    imageWidth = {{{Image_Width}}}\n    imageHeight = {{{Image_Height}}}\n    dpi = {{{Resolution_DPI_}}}\n\n\n  \n    ##--------------- ##\n    ## Error Messages ##\n    ## -------------- ##\n\n    ## --------------- ##\n    ## Main Code Block ##\n    ## --------------- ##\n\n    rank <- list()\n    for(i in 1:length(lfc.col)){\n        lfccol <- lfc.col[i]\n        sigcol <- sig.col[i]\n        columns_of_interest <- c(label.col,lfc.col[i],sig.col[i])\n        df <- df.orig %>% dplyr::select(one_of(columns_of_interest)) %>% \n                        mutate(!!sym(lfccol) := replace_na(!!sym(lfccol), 0)) %>%\n                        mutate(!!sym(sigcol) := replace_na(!!sym(sigcol), 1)) \n                        #mutate(.data[[lfc.col[i]]] = replace_na(.data[[lfc.col[i]]], 0)) %>%\n                        #mutate(.data[[sig.col[i]]] = replace_na(.data[[sig.col[i]]], 1)) \n        if (use_custom_lab==TRUE){\n          if (nchar(change_lfc_name)==0){lfc_name = lfc.col[i]}\n          if (nchar(change_sig_name)==0){sig_name = sig.col[i]}\n          colnames(df) <- c(label.col,change_lfc_name, sig_name)\n        } else {\n          lfc_name = lfc.col[i]\n          sig_name = sig.col[i]\n        }\n    \n        group <- gsub(\"_pval|p_val_\",\"\",sig_name)\n        rank[[i]] <- -log10(df[[sig_name]]) * sign(df[[lfc_name]]) \n        names(rank)[i] <- paste0(\"C_\",group,\"_rank\")\n        \n        cat(paste0(\"Genes in initial dataset: \", nrow(df),\"\\n\"))\n\n        #Select top genes by logFC or Significance\n            \n        if (value_to_sort_the_output_dataset==\"fold-change\") {\n            df <- df %>% dplyr::arrange(desc(.data[[lfc_name]]))\n        } else if (value_to_sort_the_output_dataset==\"p-value\") {\n            df <- df %>% dplyr::arrange(.data[[sig_name]]) \n        }\n\n        if (is_red) {\n            df_sub <- df[df[[sigcol]] <= pCutoff & abs(df[[lfccol]]) >= FCcutoff, ]\n        } else {\n            df_sub <- df\n        }\n\n        genes_to_label <- as.character(df_sub[1:no_genes_to_label,label.col])\n#        additional_labels <- unlist(str_split(additional_labels,\",\"))\n ## Modifying Additional Labels List:\n ## Replace commas with spaces and split the string\nsplit_values <- unlist(strsplit(gsub(\",\", \" \", additional_labels), \" \"))\nadditional_labels <- split_values[split_values != \"\"]\n\n        filter <- additional_labels %in% df[,label.col]\n        missing_labels <- additional_labels[!filter]\n        additional_labels <- additional_labels[filter]\n\n        if(length(missing_labels) > 0){\n            cat(\"Could not find:\\n\")\n            print(missing_labels)\n        }\n\n        if(use_only_addition_labels){\n            genes_to_label <- additional_labels\n        }else{\n            genes_to_label <- unique(append(genes_to_label, additional_labels))\n        }\n\n        significant = vector(length = nrow(df))\n        significant[] = \"Not significant\"\n        significant[which(abs(df[,2]) > FCcutoff)] = \"Fold change only\"\n        significant[which(df[,3] < pCutoff)] = \"Significant only\"\n        significant[which(abs(df[,2]) > FCcutoff & df[,3] < pCutoff)] = \"Significant and fold change\"\n        print(table(significant))\n        \n        # fix pvalue == 0\n        shapeCustom <- rep(19,nrow(df))\n        maxy <-  max(-log10(df[[sig_name]]), na.rm=TRUE)\n        if(ylim > 0){\n            maxy <- ylim\n        }\n      \n        cat(paste0(\"Maxy: \",maxy,\"\\n\"))\n        if(maxy == Inf){\n            # Sometimes, pvalues == 0\n            keep <- df[[sig_name]] > 0\n            df[[sig_name]][!keep] <- min(df[[sig_name]][keep])\n            shapeCustom[!keep] <- 17\n\n            maxy <- -log10(min(df[[sig_name]][keep]))\n            cat(\"Some p-values equal zero. Adjusting y-limits.\\n\")\n            cat(paste0(\"Maxy adjusted: \",maxy,\"\\n\"))\n\n        }\n\n        # By default, nothing will be greater than maxy. User can set this value lower\n        keep <- -log10(df[[sig_name]]) <= maxy\n        df[[sig_name]][!keep] <- maxy\n        shapeCustom[!keep] <- 17\n\n        names(shapeCustom)<- rep(\"Exact\",length(shapeCustom))\n        names(shapeCustom)[shapeCustom == 17] <- \"Adjusted\"\n        \n        #Remove if nothin' doin'\n        if(all(shapeCustom == 19)){\n            shapeCustom <- NULL\n        }\n        \n        maxy <- ceiling(maxy)\n\n        if (grepl(\"log\",lfc.col[i]) ){\n                xlab <- bquote(~Log[2]~ \"fold change\")\n        } else {\n            xlab <- \"Fold change\"\n        }\n        if (grepl(\"adj\",sig.col[i])){\n            ylab <- bquote(~-Log[10]~ \"FDR\")\n        } else {\n            ylab <- bquote (~-Log[10]~ \"p-value\")\n        }\n        if(use_custom_lab){\n            if(lfc_name != lfc.col[i]){\n                xlab <- gsub(\"_\",\" \",lfc_name)\n            }\n            if (sig_name != sig.col[i]){ \n                ylab <- gsub(\"_\",\" \",sig_name)\n            }\n        }\n  \n## X-axis custom range change:\nif (custom_xlim == \"\") {\n        xlim=c(floor(min(df[,lfc_name])) - xlim_additional,ceiling(max(df[,lfc_name]))+ xlim_additional)\n} else if (grepl(\",\", custom_xlim) == FALSE) {\n    xlim=c(-1*as.numeric(trimws(custom_xlim)), as.numeric(trimws(custom_xlim)))\n} else {\n    split_values <- strsplit(custom_xlim, \",\")[[1]]\n\n    # Trim whitespace and convert to numeric values\n    x_min <- as.numeric(trimws(split_values[1]))\n    x_max <- as.numeric(trimws(split_values[2]))\n\n    xlim <- c(x_min, x_max)\n}\n\n\n        p <- EnhancedVolcano( df,x=lfc_name,y=sig_name,\n                              lab=df[,label.col],\n                              selectLab = genes_to_label,\n                              title=title, #CHANGE NW: See line 78\n                              subtitle <- group,\n                              xlab=xlab,\n                              ylab=ylab,\n                              xlim=xlim,\n                              ylim=c(0, maxy + ylim_additional),\n                              pCutoff=pCutoff,\n                              FCcutoff=FCcutoff,\n                              axisLabSize=axisLabSize,\n                              labSize=labSize,\n                              pointSize=pointSize,\n                              shapeCustom=shapeCustom\n                              )\n        print(p)   \n ## Adding interactive plot with no labels:\n        p_empty <- EnhancedVolcano( df,x=lfc_name,y=sig_name,\n                              lab = rep(\"\", nrow(df)),  # Setting labels to empty strings\n                              selectLab = NULL,\n                              title=title, #CHANGE NW: See line 78\n                              subtitle <- group,\n                              xlab=xlab,\n                              ylab=ylab,\n                              xlim=xlim,\n                              ylim=c(0, maxy + ylim_additional),\n                              pCutoff=pCutoff,\n                              FCcutoff=FCcutoff,\n                              axisLabSize=axisLabSize,\n                              labSize=labSize,\n                              pointSize=pointSize,\n                              shapeCustom=shapeCustom\n                              )\n##        print(p_empty)   \n\n# Extract the data used for plotting\nplot_data <- ggplot_build(p_empty)$data[[1]]\n\npxx <- p_empty +\n  xlab(\"Fold Change\") +  # Simplify x-axis label\n  ylab(\"Significance\") + # Simplify y-axis label\n  theme_minimal() +\n  geom_point(aes(\n    text = paste(\"Gene:\", df[[label.col]], \n                 \"<br>Log2FC:\", df[[lfc_name]], \n                 \"<br>P-value:\", df[[sig_name]]),\n    colour = as.character(plot_data$colour),\n    fill = as.character(plot_data$colour)  # Set fill to the same as colour\n  ), \n  shape = 21,  # Shape that supports both colour and fill\n  size = 2,  # Size of the points\n  stroke = 0.1  # Stroke width\n  ) + scale_fill_identity()\n\n# Add interactive hover labels for the gene names\ninteractive_plot <- ggplotly(pxx, tooltip = c(\"text\"))\n\n\n    ## showing interactive plot\n    grid.newpage()\n    print(interactive_plot)\n    grid.newpage()\n    ## The end of addition\n   \n    }\n   \n    df.final <- cbind(df.orig, do.call(cbind, rank))\n    return(df.final)\n}\n\n#################################################\n## Global imports and functions included below ##\n#################################################\n\n",
	"columns": [
		{
			"key": "Column_with_Feature_ID",
			"displayName": "Column with Feature ID",
			"description": "Column from the input DEG table containing Feature ID (such as Gene Names, Isoform IDs, UniProt IDs, and so on). This is usually the first column (named \"Feature_ID\" or \"Gene\"). Only Text type columns will be allowed.",
			"paramGroup": "Basic",
			"sourceDataset": "DEG_Table",
			"defaultValue": null,
			"columnType": "STRING",
			"isMulti": null
		},
		{
			"key": "Significance_Column",
			"displayName": "Significance Column",
			"description": "Choose an unadjusted or adjusted p-value column from the input DEG table to use as the measure of significance in your Volcano plot. If your DEG analysis contained more than one contrast comparison, you will only be able to select one of these at a time. Make sure you select the same contrast that was selected for the \"Log2 Fold Change Column\" parameter.",
			"paramGroup": "Basic",
			"sourceDataset": "DEG_Table",
			"defaultValue": null,
			"columnType": "NUMBER",
			"isMulti": true
		},
		{
			"key": "Log2_Fold_Change_Column",
			"displayName": "Log2 Fold Change Column",
			"description": "Choose a log2 fold change column from the input DEG table. If your DEG analysis contained more than one contrast comparison, you will only be able to select one of these at a time. Make sure you select the same contrast that was selected for the \"Significance Column\" parameter.",
			"paramGroup": "Basic",
			"sourceDataset": "DEG_Table",
			"defaultValue": null,
			"columnType": "NUMBER",
			"isMulti": true
		}
	],
	"condaDependencies": [],
	"description": "Implementation of Bioconductor's Enhanced Volcano Plot (v1.6.0, https://bioconductor.org/packages/release/bioc/html/EnhancedVolcano.html). Template written by Matthew Angel and maintained by CCBR. Final Potomac Compatible Version: v52. Final Sugarloaf V1 Version: v55. Latest Sugarloaf V2 Version: v67. [View Documentation](https://nidap.nih.gov/workspace/notepad/view/ri.notepad.main.notepad.8fe3cd6c-db24-4b0a-b717-060cb77ecc5e)",
	"externalId": "Volcano_Plot_Enhanced_CCBR_scRNA_seq_Bulk_",
	"inputDatasets": [
		{
			"key": "DEG_Table",
			"displayName": "DEG Table",
			"description": "Dataset containing differential expression of genes (DEG) analysis output columns. Usually, this includes columns for gene names, (log) fold changes, (adjusted) p-values, and t-statistics. Other columns may be present.",
			"paramGroup": null,
			"anchorDataset": false,
			"dataType": "R_NATIVE_DATAFRAME",
			"tags": []
		}
	],
	"vectorLanguage": "R",
	"codeLanguage": "R",
	"parameters": [
		{
			"key": "P_Value_Threshold",
			"displayName": "P-Value Threshold",
			"description": "",
			"paramType": "NUMBER",
			"paramGroup": "Basic",
			"paramValues": null,
			"defaultValue": "0.001",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Log2_Fold_Change_Threshold",
			"displayName": "Log2 Fold Change Threshold",
			"description": "",
			"paramType": "NUMBER",
			"paramGroup": "Basic",
			"paramValues": null,
			"defaultValue": "1.0",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Choose_Feature_to_Label_By",
			"displayName": "Choose Feature to Label By",
			"description": "This selection determines how the feature (gene) list is sorted before choosing the top-N features as set by the \"Number of Features to Label\" parameter. Choose either (absolute) fold change, p-value, or t-statistic to label the top features by the selected metric. This also determines which features are labeled in the plot. This option is negated if only using custom labels.",
			"paramType": "SELECT",
			"paramGroup": "Label",
			"paramValues": [
				"p-value",
				"fold-change"
			],
			"defaultValue": "p-value",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Number_of_Features_to_Label",
			"displayName": "Number of Features to Label",
			"description": "To minimize clutter on the volcano plot, it is inadvisable to label every feature (gene). You can choose to label any number of features or none. The value of this parameter (N) is used to label the top N features only. See the \"Choose Features To Label By\" parameter for options on how to sort the gene list before labeling the top N features. Will be negated if the option to use only additional labels is selected.",
			"paramType": "NUMBER",
			"paramGroup": "Label",
			"paramValues": null,
			"defaultValue": "30",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Label_Only_My_Feature_List",
			"displayName": "Label Only My Feature List",
			"description": "Select TRUE when you want to label ONLY a specific list of features given in the \"My Feature List\" parameter.",
			"paramType": "BOOLEAN",
			"paramGroup": "Label",
			"paramValues": null,
			"defaultValue": "FALSE",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Use_Custom_Axis_Label",
			"displayName": "Use Custom Axis Label",
			"description": "Use text from \"Custom significance label\"?",
			"paramType": "BOOLEAN",
			"paramGroup": "Title and Axis labels",
			"paramValues": null,
			"defaultValue": "FALSE",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "My_Feature_List",
			"displayName": "My Feature List",
			"description": "Additional features (genes) to label. If the option to use only custom labels is selected, these will be the only points labeled on the plot. Otherwise, these will be plotted in addition to the other top features. This should be a comma-separated or space-delimited list.",
			"paramType": "STRING",
			"paramGroup": "Label",
			"paramValues": null,
			"defaultValue": "",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Top_Genes_Labeled_Only_If_Passing_Thresholds",
			"displayName": "Top Genes Labeled Only If Passing Thresholds",
			"description": "If TRUE, only genes passing your p-value and logFC thresholds (Basic Parameters) will be labeled on the final plot. If FALSE, genes that do not pass thresholds may be labeled, also. Default is TRUE.",
			"paramType": "BOOLEAN",
			"paramGroup": "Label",
			"paramValues": null,
			"defaultValue": "TRUE",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Label_Size",
			"displayName": "Label Size",
			"description": "",
			"paramType": "NUMBER",
			"paramGroup": "Label",
			"paramValues": null,
			"defaultValue": "4",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Custom_Significance_Label",
			"displayName": "Custom Significance Label",
			"description": "This replaces bulky names for the p-value column.",
			"paramType": "STRING",
			"paramGroup": "Title and Axis labels",
			"paramValues": null,
			"defaultValue": "p-value",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Custom_Log_Fold_Change_Label",
			"displayName": "Custom Log Fold Change Label",
			"description": "This replaces bulky column names for the fold-change column.",
			"paramType": "STRING",
			"paramGroup": "Title and Axis labels",
			"paramValues": null,
			"defaultValue": "log2FC",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Plot_Title",
			"displayName": "Plot Title",
			"description": "",
			"paramType": "STRING",
			"paramGroup": "Title and Axis labels",
			"paramValues": null,
			"defaultValue": "Volcano Plots",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Y_Limit",
			"displayName": "Y-Limit",
			"description": "Maximum value for y-axis. Defaults to -log10(min(pval)). Set to 0 for automatic scaling.",
			"paramType": "NUMBER",
			"paramGroup": "Plot",
			"paramValues": null,
			"defaultValue": "0",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Custom_X_axis_limits",
			"displayName": "Custom X-axis limits",
			"description": "Leave empty for automatic scaling, put one number for symmetrical scale (i.e, putting \"5\" would result in a range from \"-5\" to \"5\"), or put two numbers separated by comma for \"asymmetrical\" scale (i.e, putting \"-2,4\" would result in a range from \"-2\" to \"4\")",
			"paramType": "STRING",
			"paramGroup": "Plot",
			"paramValues": null,
			"defaultValue": "",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "X_Limit_Padding",
			"displayName": "X-Limit Padding",
			"description": "Add additional units to x-limit",
			"paramType": "NUMBER",
			"paramGroup": "Plot",
			"paramValues": null,
			"defaultValue": "0",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Y_Limit_Padding",
			"displayName": "Y-Limit Padding",
			"description": "Adds additional units to y-limit.",
			"paramType": "NUMBER",
			"paramGroup": "Plot",
			"paramValues": null,
			"defaultValue": "0",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Axis_Label_Size",
			"displayName": "Axis Label Size",
			"description": "",
			"paramType": "NUMBER",
			"paramGroup": "Plot",
			"paramValues": null,
			"defaultValue": "24",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Point_Size",
			"displayName": "Point Size",
			"description": "",
			"paramType": "NUMBER",
			"paramGroup": "Plot",
			"paramValues": null,
			"defaultValue": "2",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Image_Width",
			"displayName": "Image Width",
			"description": "",
			"paramType": "NUMBER",
			"paramGroup": "Image",
			"paramValues": null,
			"defaultValue": "3000",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Image_Height",
			"displayName": "Image Height",
			"description": "",
			"paramType": "NUMBER",
			"paramGroup": "Image",
			"paramValues": null,
			"defaultValue": "3000",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		},
		{
			"key": "Resolution_DPI_",
			"displayName": "Resolution (DPI)",
			"description": "",
			"paramType": "NUMBER",
			"paramGroup": "Image",
			"paramValues": null,
			"defaultValue": "300",
			"condition": null,
			"content": null,
			"objectPropertyReference": null
		}
	],
	"title": "Volcano Plot - Enhanced [CCBR] [scRNA-seq] [Bulk]",
	"templateApiVersion": "0.1.0"
}